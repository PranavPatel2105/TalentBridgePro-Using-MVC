@{
    ViewData["Title"] = "View Applications";
     Layout = "~/Views/Shared/_RecruiterLayout.cshtml";
     var username = @Context.Session.GetString("Name");
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://kendo.cdn.telerik.com/2024.1.319/styles/kendo.default-v2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://kendo.cdn.telerik.com/2024.1.319/js/kendo.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    body {
        background: #f4f8ff;
    }





    .custom-select {
        appearance: none;
        background-color: #f8fafc;
        border: 1.5px solid #dbe2ea;
        border-radius: 10px;
        padding: 8px 34px 8px 12px;
        font-size: 13px;
        font-weight: 500;
        color: #334155;
        cursor: pointer;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='%23334155' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658c-.566-.63-.106-1.658.753-1.658h9.592c.86 0 1.32 1.027.753 1.658L8.753 11.14a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        transition: all 0.25s ease;
    }

    .custom-select:hover {
        border-color: #1e88e5;
        background-color: #fff;
    }

    .custom-select:focus {
        outline: none;
        border-color: #0d47a1;
        box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.15);
    }


    .view-cv-btn {
        display: inline-block;
        padding: 6px 16px;
        border-radius: 30px;
        border: 2px solid #1e88e5;
        color: #1e88e5;
        font-size: 13px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .view-cv-btn:hover {
        background: #1e88e5;
        color: #fff;
    }


    .page-header {
        background: linear-gradient(135deg, #0d47a1, #1565c0);
        color: #fff;
        border-radius: 14px;
        padding: 22px 26px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .page-header .icon {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }

    .card-box {
        background: #fff;
        border-radius: 14px;
        padding: 22px;
        box-shadow: 0 8px 22px rgba(0, 0, 0, 0.06);
    }

    .badge-status {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge-pending {
        background: #fff8e1;
        color: #f57c00;
    }

    .badge-accepted {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .badge-rejected {
        background: #fdecea;
        color: #c62828;
    }

    /* --- New Action Dropdown Theme --- */
    @* .custom-select {
        border: 1.5px solid #e0e6ed;
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 13px;
        color: #334155;
        background-color: #f8fafc;
        transition: all 0.3s ease;
        cursor: pointer;
        outline: none;
    } *@

    .custom-select:hover {
        border-color: #1565c0;
        background-color: #fff;
    }

    .custom-select:focus {
        border-color: #0d47a1;
        box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.1);
    }

    /* =====================================================
   KENDO DEFAULT-V2 – FORCE BLUE THEME (FINAL FIX)
   ===================================================== */

    /* Normal item */
    .k-list-item {
        padding: 10px 14px !important;
        font-size: 13px !important;
        color: #334155 !important;
    }

    /* Hover item */
    .k-list-item:hover,
    .k-list-item.k-hover {
        background-color: #e3f2fd !important;
        color: #0d47a1 !important;
    }

    /* Selected item (this was orange/red) */
    .k-list-item.k-selected,
    .k-list-item.k-selected:hover {
        background-color: #1e88e5 !important;
        color: #ffffff !important;
    }

    /* Remove default gradient / red */
    .k-selected,
    .k-selected.k-hover {
        background-image: none !important;
    }

    /* Dropdown focus border */
    .k-dropdownlist.k-focus {
        border-color: #1e88e5 !important;
        box-shadow: 0 0 0 3px rgba(30, 136, 229, .25) !important;
    }

    /* Popup curve */
    .k-list-container {
        border-radius: 12px !important;
        overflow: hidden;
    }
</style>

<div class="container mt-4">

    <div class="page-header">
        <div class="icon">📄</div>
        <div>
            <h5 class="mb-0">Job Applications</h5>
            <div class="d-flex align-items-center gap-2 mt-1">
                <small id="jobRoleText"></small>
                <span class="badge bg-light text-primary fw-semibold" id="applicationCount"></span>
            </div>
        </div>
    </div>

    <div class="card-box">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Applicant Name</th>
                    <th>Email</th>
                    <th>Resume</th>
                    <th>Status</th>
                    <th style="width:180px;">Action</th>
                </tr>
            </thead>
            <tbody id="applicationTable"></tbody>
        </table>
    </div>

</div>

<script>
    const token = "@Html.Raw(Context.Session.GetString("JWT"))";
    console.log("JWT Token:", token);
    $(document).ready(function () {

        const c_job_id = @ViewBag.JobId;     // dynamic later

        loadApplications();

        function loadApplications() {
            $.ajax({
                url: `http://localhost:5140/api/RecruiterApi/job/${c_job_id}/applications`,
                type: "GET",
                headers: {
                    "Authorization": "Bearer " + token
                },
                success: function (res) {
                    console.log(res)
                    const tbody = $("#applicationTable");
                    tbody.empty();

                    if (!res.data || res.data.length === 0) {
                        $("#jobRoleText").text("");
                        $("#applicationCount").text("0 Applications");
                        tbody.append(`
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            No applications found
                        </td>
                    </tr>
                `);
                        return;
                    }

                    $("#jobRoleText").text("Job Role : " + res.data[0].c_role);
                    $("#applicationCount").text(res.data.length + " Applications");

                    res.data.forEach(app => {

                        let statusBadge =
                            app.c_status === "accepted"
                                ? `<span class="badge-status badge-accepted">Accepted</span>`
                                : app.c_status === "rejected"
                                    ? `<span class="badge-status badge-rejected">Rejected</span>`
                                    : `<span class="badge-status badge-pending">Pending</span>`;

                        tbody.append(`
                    <tr>
                        <td class="fw-semibold text-dark">${app.c_name}</td>
                        <td>${app.c_email}</td>
                        <td>
                            <a href="/uploads/resumes/${app.c_resume_file}" target="_blank" class="view-cv-btn">
                                View CV
                            </a>
                        </td>
                        <td>${statusBadge}</td>
                        <td>
                            <input id="status_${app.c_application_id}" />
                        </td>
                    </tr>
                `);

                        setTimeout(() => {
                            $("#status_" + app.c_application_id).kendoDropDownList({
                                dataSource: [
                                    { text: "⏳ Pending", value: "pending" },
                                    { text: "✅ Accepted", value: "accepted" },
                                    { text: "❌ Rejected", value: "rejected" }
                                ],
                                dataTextField: "text",
                                dataValueField: "value",
                                value: app.c_status,
                                change: function () {
                                    updateStatus(
                                        app.c_application_id,
                                        app.c_status,
                                        this.value()
                                    );
                                }
                            });
                        }, 0);
                    });
                },
                error: function (err) {
                    console.error(err);
                    Swal.fire("Error", "Unauthorized or failed to load applications", "error");
                }
            });
        }


        window.updateStatus = function (c_application_id, oldStatus, newStatus) {
            if (oldStatus === newStatus) return;

            Swal.fire({
                title: "Update Application Status?",
                text: `Change status to "${newStatus}"?`,
                icon: "question",
                showCancelButton: true,
                confirmButtonColor: "#1e88e5",
                cancelButtonColor: "#aaa",
                confirmButtonText: "Yes, Update"
            }).then((result) => {
                if (!result.isConfirmed) {
                    loadApplications(); // revert dropdown
                    return;
                }

                $.ajax({
                    url: `http://localhost:5140/api/RecruiterApi/application/${c_application_id}/status`,
                    type: "PUT",
                    headers: {
                        "Authorization": "Bearer " + token
                    },
                    contentType: "application/json",
                    data: JSON.stringify({ c_status: newStatus }),
                    success: function () {
                        Swal.fire("Updated!", "Application status updated successfully.", "success");

                        loadApplications();
                    },
                    error: function () {
                        Swal.fire("Error!", "Failed to update application status.", "error");
                        loadApplications();
                    }
                });
            });
        };
    });
</script>